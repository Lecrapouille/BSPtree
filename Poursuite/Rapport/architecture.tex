%%====================================================================
%%==================================================================== 
%\chapter{Architecture du CyCab}
\chapter{Architecture matérielle d'un CyCab}
\section{Histoire de la conduite automatique}
%%====================================================================
%%==================================================================== 

Dans le cadre de la route automatisée, l'INRIA a imaginé un système de
transport original de véhicules en libre-service pour la ville de
demain. Ce système de transport public est basé sur une flotte de
petits véhicules électriques spécifiquement conçus pour les zones où
la circulation automobile doit être fortement restreinte. Pour tester
et illustrer ce système, un prototype, nommé CyCab (contraction pour
Cybar Cab), a été réalisé (Figure \ref{CyCab1}).

\dessin{figures/CyCab/CyCab1}{0.5}{Un Cyber Cabi.}{CyCab1}

Les chercheurs de l'INRIA et de l'Inrets (Institut National de
Recherche sur les Transports et leur Sécurité) travaillent depuis 1991
sur de nouveaux moyens de transport intelligent pour la ville. Ils
étudient en particulier le concept du libre-service et celui de la
voiture automatique. Les premiers résultats de recherche ont débouché
sur le projet Praxitèle (1993-1999), qui était en exploitation à
Saint-Quentin-en-Yvelines. Les partenaires industriels du projet
étaient CGFTE (la filiale transports publics de Vivendi), Dassault
Electronique, EDF et Renault.
 
Dans le cadre du projet Praxitèle l'INRIA a démontré la faisabilité de
la conduite automatique sous certaines conditions : créneau et train
de véhicule expérimenté sur une Ligier électrique instrumentée à cet
effet.
 
Pour des raisons de législation et de responsabilité ces automatismes
de conduite n'ont pas pu être implémentés sur les Clio électriques de
Saint-Quentin-en-Yvelines. Le CyCab a ensuite été développé par
l'INRIA avec l'aide de l'Inrets, de EDF, de la RATP et de la société
Andruet S.A. pour montrer le potentiel de l'informatique dans la
conduite de véhicules. Le CyCab est un véhicule électrique à quatre
roues motrices et directrices avec une motorisation indépendante pour
chacune des roues et pour la direction. Pour contrôler et commander
les 9 moteurs du CyCab (4 de traction, 1 de direction et 4 de frein),
une architecture matérielle a été choisie. Elle est constituée de
noeuds intelligents pouvant gérer les différents moteurs du CyCab et
répartie autour d'un bus de terrain CAN (Controller Area Network),
très répandu dans le monde de l'automobile.
 
Le rôle des noeuds est d'asservir les moteurs en fonction des
consignes de vitesse et de braquage qui transitent sur le bus CAN soit
en provenance de la position du joystick, soit par un programme de
planification de trajectoires. Le noeud doit donc non seulement être
capable de fournir la puissance nécessaire aux moteurs, mais aussi
exécuter les boucles d'asservissement de vitesse ou de position. Pour
ce faire il doit prendre en compte un certain nombre d'informations en
provenance des capteurs proprioceptifs : état, odomètrie, fins de
course, mesures de température, de courant, ...

%% Depuis une trentaine d'années, de nombreuses recherches ont été effectuées
%% afin d'automatiser à différents niveaux les voitures et les transports en
%% commun (état de l'art dans \cite{SAT}). Un projet antérieur de l'INRIA a déjà 
%% proposé des résultats intéressants sur les trains de véhicules à accrochage 
%% immatériel, appelé aussi trains de véhicules à accrochage virtuel. Mais le 
%% matériel utilisé était très coûteux (caméra très haute résolution, plusieurs 
%% cartes spécifiques telles carte d'acquisition et carte de traitement d'images).
%% Notre but est donc de faire un train de véhicules sans lien matériel au coût le 
%% plus bas possible.
%% Par la suite et pour simplifier, nous ne parlerons plus que du train de 
%% véhicules seulement.

Un train de véhicules est constitué d'un véhicule de tête conduit par un 
chauffeur et d'autres véhicules automatisés, chacun suivant celui qui le 
précède. Ainsi le premier véhicule est suivi par le deuxième qui à son tour est 
suivi par le troisième ... C'est donc une procession de véhicules. Ce type 
d'automatisation a été pensé pour les conduites sur autoroute ou dans les 
périphériques. Ce procédé a l'avantage de maximiser la vitesse 
des véhicules ainsi que leur nombre tout en minimisant les accidents.

%% Dans le cadre de la route automatisée \cite{LARA}, l'INRIA a imaginé un système 
%% de transport original de véhicules en libre-service pour la ville de demain. 
%% Ce système de transport public est basé sur une  flotte de petits véhicules
%% électriques spécifiquement con\c{c}us pour les zones où la circulation 
%% automobile doit être fortement restreinte. Pour tester et illustrer ce 
%% système, deux prototypes, nommés CyCabs, ont été réalisés dans un premier temps.
%% Le premier est localisé à l'UR (Unité de Recherche) de Rocquencourt et le 
%% second est localisé à l'UR Rhône-Alpes. Leszek Lisowski, ingénieur-expert 
%% SHARP/PRAXITÈLE, a travaillé durant deux ans sur la conception et la réalisation
%% des deux prototypes \cite{DTCyCab}. Les deux CyCabs comportent des différences 
%% de conception importantes. Ainsi, autant le premier prototype donnait toute 
%% satisfaction, autant le second posait d'énormes problèmes de fiabilité 
%% \cite{RTCyCab}.

%% L'entreprise Robosoft commercialise les CyCabs depuis quelques années et chaque 
%% UR de l'INRIA en possède au moins un.

\section{Travail effectué}
Un des problèmes que j'ai rencontré pendant ce stage fût le manque de documentation. J'ai
ajouté dans ce rapport ma propre documentation. J'ai également effectué une mise à jour matérielle et logicielle
du PC embarqué et fait quelques maintenance sur les noeuds MPC.

%% FIXME Ajouter le fichier EXCEL DES CARTES MPC

 
%%====================================================================
\section{Architecture matérielle}
%%====================================================================
%%====================================================================
\subsection{Caractéristique générale d'un CyCab}

Il existe différents types de CyCab.  Celui utilisé a les caractéristiques suivantes :
\begin{itemize}
  \item[$\bullet$] longueur : 1,90 m
  \item[$\bullet$] largeur : 1,20 m
  \item[$\bullet$] poids total avec batteries : 300 kg
  \item[$\bullet$] 4 roues motrices et directrices
  \item[$\bullet$] vitesse théorique maximale : 20 km/h
  \item[$\bullet$] autonomie : 2 heures d'utilisation continue
  \item[$\bullet$] capacité d'accueil : 2 personnes
  \item[$\bullet$] conduite manuelle ou automatique.
\end{itemize}

\dessin{figures/CyCab/CyCab2}{0.8}{Architecture d'un CyCab.}{CyCabcoupe}

La figure (\ref{CyCabcoupe}) montre une vue en coupe de
l'architecture du CyCab qui est constituée de :
\begin{itemize}
\item[$\bullet$] 1 ensemble de batteries avec un gestionnaire
  automatique de charge (10) et un bouton arrêt d'urgence qui est soit
  de type poussoir (2) soit de type radiocommandé (1).
\item[$\bullet$] 2 cartes électroniques (5) et (6) d'acquisition de données
  comprenant chacune un microprocesseur 32 bit Power PC (appelés
  MPC555). Chaque carte permet de contrôler 2 roues du CyCab. Nous
  reviendrons plus tard sur l'architecture de ces cartes que l'on
  appellera par la suite \emph{noeuds}.
\item[$\bullet$] 1 PC embarqué au format rack (taille 2U), placé sous
  le siège (2), possédant un processeur Intel cadencé à 3 GHz, avec un
  Linux temps réel, RTAI. L'ensemble est alimenté par une tension
  d'entrée de -48V (350W) et non de 220V. L'écran est situé en (3).
\item[$\bullet$] 2 bus CAN indépendants~: le bus CAN 0 permet la
  communication entre les 2 MPC555 et le PC embarqué, alors que le bus
  CAN 1 permet d'ajouter d'éventuels futurs composants électronique.
\item[$\bullet$] 4 moteurs et leurs freins électriques (8) et (9)
  contrôlés par 4 contrôleurs de moteur appelés Curtis PMC 1227 (9)
  servant d'amplificateurs de puissance pour contrôler la vitesse des
  roues. La consigne de vitesse est donnée par une tension de 0 à 5V aux
  Curtis qui fourniront des signaux PWM adéquats aux moteurs. Les
  Curtis protègent les noeuds des contre-courants des moteurs, quand
  par exemple, on les arrête brusquement.
\item[$\bullet$] 4 décodeurs incrémentaux donnant la vitesse des roues (8).
\item[$\bullet$] 1 vérin de direction électrique alimenté par signal PWM (7)
  faisant pivoter les 4 roues.
\item[$\bullet$] 1 encodeur absolu avec sortie SPI et donnant l'angle des
  roues.
\item[$\bullet$] 1 joystick (2) fournissant deux courants indiquant :
  -- la consigne de vitesse des roues, -- la consigne de direction
  des 4 roues.
\item[$\bullet$] Depuis ce stage, le CyCab possède une caméra type
  webcam (4) se branchant sur un port FireWire du PC embarqué.
\end{itemize}

Nous verrons, dans les prochains chapitres, comment ces capteurs et
actionneurs sont utilisés pour faire rouler le CyCab que ce soit pour
de la conduite manuelle ou de la conduite automatique.

%%====================================================================
\subsection{L'architecture du système}
%%====================================================================
La figure (\ref{CyCabuml}), montre en formalisme UML, l'architecture
complète du CyCab avec ses moyens de communication, à savoir les deux
noeuds, le PC embarqué et les deux bus CAN.

\dessin{figures/CyCab/archi}{0.5}{Architecture d'un CyCab.}{CyCabuml}

Comme nous l'avons expliqué dans le chapitre précédent, SynDEx va distribuer le programme de conduite sur les 2
noeuds et sur le PC embarqué qui communiqueront grâce au bus CAN 0.  Le
passager (ou acteur en formalisme UML) du CyCab peut communiquer avec
le PC embarqué (clavier/souris/écran, USB, FireWire, Ethernet, CAN 1) mais n'a
accès aux noeuds que par l'intermédiaire du bus CAN 1.

Comme nous le verrons, chapitre \ref{chaprtai}, une partie du
programme de conduite (manuel ou automatique) va tourner sur un Linux
temps réel (RTAI ) servant essentiellement de timer 10 ms aux deux noeuds MPC.
La partie LXRT va gérer les images de la caméra, appliquer le
traitement de l'image et communiquer avec RTAI via une mémoire
partagée. Un programme Linux peut observer le flot de données
pour, par exemple, pouvoir les faire rejouer en simulation.

Comme nous le verrons, chapitre \ref{chaprobucar}, le
programme de conduite s'exécute sur les deux noeuds. Il
lit les données fournies par les capteurs (direction des roues,
vitesse des roues, ...).  Il calcule la régulation et puis envoie le résultat aux différents
actuateurs gérant les quatre roues du CyCab (traction et direction). La communication se fait
soit par sortie série SPI, soit par lecture analogique ou optique.

%%====================================================================
\subsection{Noeuds à coeur MPC}
%%====================================================================

Les noeuds du CyCab sont constitués de quatre parties démontables, dont
nous allons expliquer l'utilité~:
\begin{enumerate}
\item une carte mère,
\item une carte fille s'emboîtant sur la carte mère,
\item un micro-contrôleur Motorola MPC555,
\item une petite boite, de couleur noire.
\end{enumerate}

\dessin{figures/CyCab/cartes}{0.5}{Carte mère (à gauche) et fille (à
  droite).}{cartes}

Les entrées-sorties de la carte mère (à gauche, figure (\ref{cartes})), sont~:
\begin{enumerate}
\item L'emplacement du MPC555. Par convention avec les autres CyCab de
  l'équipe IMARA, on donnera l'identifiant 4000 au processeur du
  noeud arrière et l'identifiant 4001 au processeur du noeud avant.
\item L'emplacement de l'alimentation. Selon l'ancienneté du CyCab, la
  tension délivrée par l'alimentation est soit de 24 VDC, soit de
  48 VDC. La plupart des cartes mères ont été modifiées pour
  fonctionner avec ces 2 types de tension. Elles sont aussi censées
  être protégées électriquement de l'extérieur grâce à des optocoupleurs
  (composants de couleur blanche sur la figure (\ref{cartes})) mais des
  problèmes ont été détectés à ce niveau.
\item C'est l'entrée de la boite de couleur noire. Sans cette boite le
  CyCab ne peut démarrer. Selon les dires de Robosoft, elle permet de
  remettre à zéro le MPC555 lorsque le bouton arrêt d'urgence est enfoncé.
\item L'entrée du joystick (uniquement pour le noeud avant du CyCab).
\item Une prise  électronique permet de connecter des fils et d'en
  propager d'autres sur l'axe 11. Ces fils sont la masse et un signal 5V.
\item L'entrée/sortie sérielle de type SPI vers l'encodeur
  absolu. Seul le connecteur du bas est utilisé.
\item Ne sert pas.
\item Ne sert pas.
\item L'entrée/sortie CAN 0 permettant la communication avec l'autre
  noeud et le PC embarqué. Par convention avec les autres CyCab de
  l'équipe IMARA, la vitesse du bus CAN est de 800 Kbit/s.
\item L'entrée/sortie CAN 1 permettant de brancher des équipements
  externes au CyCab (PC portable par exemple).
\item Masse et un signal 5 V.
\end{enumerate}

Je n'ai pas analysé les entrées/sorties de la carte fille, figure
(\ref{cartes}) à droite. Mais il faut brancher les axes 13, 14 et 15
aux câbles dont les numéros correspondent et qui proviennent du
châssis.

Après réparation d'une paire de noeud, l'application de conduite
manuelle dont nous parlerons plus en détail
chapitre \ref{chaprobucar}, s'arrêtait brusquement lorsque les roues
se mettaient à tourner. Robosoft, nous a dit que l'actuateur de
direction des roues générait de forts champs électromagnétiques (CEM)
qui perturbent la carte mère. Il nous a conseillé de faire un rappel
de masse, à savoir brancher un fil connectant la masse des capteurs de
direction avant et arrière à la carcasse du CyCab. L'application du chapitre
\ref{chaprobucar} a re-fonctionnée depuis.

%%====================================================================
\section{PC embarqué}
%%====================================================================

Le CyCab contient un PC embarqué, de forme horizontale (format rack taille 2U), placé sous le siège,
qui communique avec les 2 noeuds via le bus CAN 0. Avant mon stage, le
PC possédait un processeur Intel à 233 MHz, un Linux temps réel
(kernel 2.4, RTAI 2.4 et dont le serveur X ne pouvait se lancer), ce
qui était suffisant pour faire tourner l'application de conduite
manuelle (dont nous parlerons plus en détail chapitre
\ref{chaprobucar}). Mais sa vitesse est trop faible pour faire
du traitement de l'image, et donc par conséquent, de faire du suivi
automatique basé sur une caméra.

J'ai remis à jour, l'architecture du PC embarqué. Il est désormais constitué de~:
\begin{itemize}
\item[$\bullet$] Le même châssis alimenté par une tension -48 V.
\item[$\bullet$] Une carte mère contenant un Pentium 4 cadencé à 3 GHz et
  512 Mo de mémoire vive.
\item[$\bullet$] Une carte de fond de panier, référence PCI-5SDA-RS-R30 à 2 slots PCI et 4
  ISA. Une nouvelle version contient 4 slots PCI (confère figure (\ref{reiser})).
\item[$\bullet$] Une carte SPI pour la communication CAN.
\item[$\bullet$] Une carte SPI pour la communication IEEE 1394.
\item[$\bullet$] Une carte graphique PCI NVidia GX 5200, la puce graphique
  incluse dans la carte mère est suffisante pour un affichage confortable.
\item[$\bullet$] Un disque dur IDE à 20 Go.
\end{itemize}

\begin{minipage}[b]{.45\linewidth}
\centering\epsfig{figure=figures/cycab/pci5sda, width=\linewidth}
\caption{Carte riser.}\label{reiser}
\end{minipage}\hspace{2cm}
\begin{minipage}[b]{.2\linewidth}
\centering\epsfig{figure=figures/cycab/cartemere, width=\linewidth}
\caption{Carte mère.}\label{cartemere}
\end{minipage}

Le système d'exploitation du PC est un Linux temps réel dont la
distribution est une Debian 4.0 release 0. Le noyau Linux installé par
défaut par Debian est le 2.6.18. Un noyau
2.6.18-52 a été compilé et patché pour le temps réel avec RTAI 3.4. Le
chapitre \ref{chaprtai} expliquera plus en détail son fonctionnement.

Il est intéressant de noter que le format de la carte mère du PC embarqué n'est pas
identique au format ATX des cartes mères des PC personnels. Sa largeur est la moitié
d'une carte mère d'un PC standard et contient que le processeur et la mémoire vive.
Elle possède 2 slots mâles qui lui permettent de s'insérer dans une carte de fond de panier,
ou \emph{riser} en anglais, pour pouvoir ajouter des cartes PCI ou ISA. Voir figure (\ref{reiser}).


%%====================================================================
\section{Capteurs et actuateurs}
%%====================================================================
\subsection{Caméra FireWire}\label{ieee1394}
%%====================================================================
La caméra FireWire que nous utilisons est une Fire-I fabriquée par UniBrain (\ref{firei}), sa taille est $35 \times 65$ mm. Sa résolution maximale est de $640 \times 480$, elle peut donner des images au format monochrome, RGB ou YUV à des fréquences de 30, 15, 7.5 et 3.5 images par seconde.

\dessin{figures/cycab/firei}{0.6}{Caméra UniBrain Fire-I.}{firei}

Nous utilisons les librairies libraw1394 et libdc1394 \cite{1394} pour obtenir les images.
Les configurations que nous avons choisies sont~: format YUV422, taille $320 \times 240$,
7.5 images par seconde. Ces options peuvent facilement être modifiées. 

Les termes FireWire, IEEE 1394 ou i.Link, sont synonymes. L'article \cite{LM69}, nous dit
que ce bus est un bus série plug and play, pouvant supporter jusqu'à 63 périphériques et
permettant différentes topologies alors que l'USB ne permet que des
configurations en étoile. Le débit maximum de la norme 1394 le plus
répandu est de 400 Mbit/s, ce qui permet de fournir des débits plus
élevés que celui de la norme USB 2.0.

Il existe 2 modes distincts pour le bus 1394~: -- le mode asynchrone
et -- le mode isochrone. Le mode isochrone est le plus rapide car il
permet l'envoie de paquets de taille fixe à intervalle de temps
régulier et donc il n'existe plus d'accusé de réception. Même si le
débit théorique est de 400 Mbit/s, le cadencement des paquets d'une
transmission isochrone fait que le débit utile est de 256 Mbit/s.

On fera donc attention à ne pas dépasser ce débit maximum si on veut
brancher, par exemple deux caméras sur une même carte pour faire par
exemple, du traitement de l'image avec des images stéréo. Pour cela on
jouera sur les paramètres suivants~: -- la taille de l'image, son
format, -- son taux de compression, -- le nombre d'images par seconde.
Par exemple, une image YUV422 de taille $640 \times 480$ à 30 images
par seconde aura un débit de 147 Mbit/s. Il n'est donc pas possible de
mettre deux caméras sur la même carte, il faut les brancher sur deux
cartes différentes.

%%====================================================================
\subsection{Contrôleur Curtis}\label{curtis}
%%====================================================================

La figure (\ref{noeud}) montre une photo de l'avant d'un CyCab sans sa coque. L'arrière est la réplique exacte de l'avant. Nous ne voyons pas sur la photo les roues gauche et droit, mais nous voyons leurs suspensions, le vérin qui permet la direction, le contrôleur PWM qui gère le vérin, le contrôleur Curtis gérant la motricité des roues, ainsi que le noeud à coeur MPC.

\dessin{figures/cycab/noeud}{0.5}{CyCab sans sa coque, vu de l'avant.}{noeud}

Comme le but de mon stage était de faire du suivi longitudinal de CyCab, je me suis uniquement documenté sur le contrôleur Curtis PMC 1227. Dont voici le résumé du fonctionnement.

Le datasheet du Curtis PMC 1227 \cite{curtis}, nous indique que ce composant est un contrôleur pour moteur électrique. Il fournit au moteur une tension comprise entre 24 et 48 V (allant jusqu'à 200 A) et il programmable grâce à une sonde. 

La sonde, nous indique que les paramètres suivants on été mis.
\begin{center}
\begin{tabular}{|c|c|c|c|} \hline
Nom & valeur (\%) & Nom & valeur (\%)\\ \hline
Throttle & 0 & M1,2 rec decel & 0\\ \hline
Spd limit pot & 100 & M1,2 max speed & 100 \\ \hline
Batt volt & 48.5 & M1,2 min speed & 0 \\ \hline
Mode input A & on & M1,2 main C/L & 60 \\ \hline
Frwrd input & off & M1,2 IR coef & 0 \\ \hline
Reverse input & off & reverse speed &100 \\ \hline
Inhibit in & on & Ramp shape & 50 \\ \hline
main cont & off & Creep speed & 0\\ \hline
em brake drvr & off & Brake DLY & 1.0\\ \hline
push enable in & off & Thrttle type & 0\\ \hline
Thrtl autolocal & off & direct & 0\\ \hline
M1, M2 accel rate & 0 & Thrttle gain & 100 \\ \hline
M1, M2 decel rate & 0 & thrttle deadband & 5.0 \\ \hline
high pedal dis & on & &\\ \hline
\end{tabular}
\end{center}

Avec ses informations et en se rapportant au manuel, on en déduit la figure (\ref{wigwag}) qui, à gauche, montre la correspondance entre la plage de tension entrant dans le Curtis et à droite, la sortie PWM (signal carré dont le rapport cyclique est variable) alimentant le moteur DC.

Dans la plage de tension 2.4V et 2.6V, le moteur ne tourne pas, c'est la zone neutre. De 0.58V à 2.4V et de 2.6V à 4.44V la sortie PWM varie linéairement par rapport à la tension.

\dessin{figures/CyCab/wigwag}{0.5}{Comportement du Curtis.}{wigwag}

%%====================================================================
\subsection{Vérin de direction}
%%====================================================================
On a remarqué que les roues du CyCab n'étaient pas bien centrées. Le vérin doit être réglé.


%%====================================================================
%\section{Protocole CAN}
%%====================================================================

%%====================================================================
\section{Problèmes rencontrés}
%%====================================================================
\subsection{Noeuds MPC}
J'ai eu  un problème électronique avec les cartes mères. Lors d'un test, une carte refusait de communiquer. La réparation de la carte par la société Robotsoft a duré 2 mois. La nouvelle carte, ne fonctionnait pas correctement, non plus.

\subsection{PC embarqué}
Lors du remplacement du PC embarqué, une barrette mémoire RAM était défectueuse. 
Il est intéressant de savoir diagnostiquer ce problème. Dans mon cas
elle empêchait l'installation de certaines distributions Linux et quand bien même, l'installation réussissait, des messages d'erreur du type {\tt *** glib detected *** corrupted double-linked list : 0xXXXXX} apparaissaient. Une méthode pour diagnostiquer ce problème consiste à installer l'image {\tt memtest} qui se comporte comme une image noyau Linux et donc se lance avec {\tt grub} et teste la mémoire. 

\subsection{Risque potentiel avec le joystick}
Un problème grave peut arriver si le joystick se casse. Les plages de valeur des signaux analogiques du joystick sont comprises entre 0 et 5V. Le zéro est codé avec la tension 2.5V. Ce centrage est très dangereux car si le joystick a une défaillance, la tension devient nulle et le contrôleur croit que 
la consigne est au maximum et donc emballe les roues.


